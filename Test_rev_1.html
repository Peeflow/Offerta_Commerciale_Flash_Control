<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Control - Sistema Preventivi Completo</title>
    <style>
        /* ... il tuo CSS esistente ... */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .document {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            padding: 25mm;
            box-shadow: 0 0 30px rgba(0,0,0,0.15);
            border-radius: 10px;
            min-height: 297mm;
            position: relative;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 4px solid #2c5aa0;
            padding-bottom: 20px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 20px;
            border-radius: 10px;
            margin: -20px -20px 30px -20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            min-width: 300px;
        }
        
        .logo {
            width: 240px; /* MODIFIED: Raddoppiate le dimensioni del logo */
            height: 160px; /* MODIFIED: Raddoppiate le dimensioni del logo */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid #2c5aa0;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            color: white;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        
        .logo:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        #logoImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            border-radius: 12px;
        }
        
        #logoText {
            display: block;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .company-info {
            flex: 1;
            min-width: 200px;
        }
        
        .company-info h1 {
            font-size: 36px;
            font-weight: bold;
            color: #2c5aa0;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .company-info .subtitle {
            font-size: 18px;
            color: #666;
            margin: 5px 0;
            font-weight: 600;
        }
        
        .company-info .tagline {
            font-size: 13px;
            color: #2c5aa0;
            font-weight: bold;
            margin-top: 10px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .company-info .tagline:hover {
            background: linear-gradient(135deg, #bbdefb, #90caf9);
            transform: translateX(3px);
        }
        
        .document-info {
            text-align: right;
            font-size: 14px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            min-width: 200px;
            max-width: 250px;
        }
        
        .document-info div {
            margin: 8px 0;
            padding: 5px 0;
            line-height: 1.3;
        }
        
        .document-info strong {
            color: #2c5aa0;
            font-weight: 700;
        }
        
        .section {
            margin: 30px 0;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2196f3, #21cbf3);
        }
        
        .section h3 {
            color: #2c5aa0;
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section h3::before {
            content: 'üìã';
            font-size: 18px;
        }
        
        .client-section {
            background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
        }
        
        .client-section h3::before {
            content: 'üë§';
        }
        
        .reference-section {
            background: linear-gradient(135deg, #fff8e1, #fff3cd);
        }
        
        .reference-section h3::before {
            content: 'üìé';
        }
        
        .conditions-section {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
        }
        
        .conditions-section h3::before {
            content: 'üìÑ';
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px 20px;
            align-items: center;
        }
        
        .info-grid label {
            font-weight: bold;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid .editable {
            color: #333;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            min-height: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .conditions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .quotation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 40px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }
        
        .quotation-table th {
            background: linear-gradient(135deg, #2c5aa0, #1976d2);
            color: white;
            padding: 20px 15px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: inset 0 -2px 0 rgba(255,255,0,0.2);
        }
        
        .quotation-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
            background: white;
            transition: background 0.2s ease;
        }
        
        .quotation-table tbody tr:hover {
            background: #f8f9fa !important;
        }
        
        .quotation-table tbody tr:nth-child(even) {
            background: #fafbfc;
        }
        
        .section-header-cell {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
            color: #1976d2 !important;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 20px !important;
        }
        
        /* COLONNE TABELLA RIDIMENSIONATE */
        .quotation-table th:nth-child(1),
        .quotation-table td:nth-child(1) {
            width: 50px;
            text-align: center;
            font-weight: bold;
            color: #2c5aa0;
            font-size: 18px;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
        }
        
        .quotation-table th:nth-child(2),
        .quotation-table td:nth-child(2) {
            width: 60%;
        }
        
        .quotation-table th:nth-child(3),
        .quotation-table td:nth-child(3) {
            width: 15%;
            text-align: center;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .quotation-table th:nth-child(4),
        .quotation-table td:nth-child(4) {
            width: 20%;
            text-align: right;
            font-weight: bold;
            color: #2e7d32;
            background: linear-gradient(135deg, #f1f8e9, #e8f5e8);
        }
        
        .quotation-table th:nth-child(5),
        .quotation-table td:nth-child(5) {
            width: 20%;
            text-align: right;
            font-weight: bold;
            color: #2e7d32;
            background: linear-gradient(135deg, #f1f8e9, #e8f5e8);
        }
        
        .notes-section {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
        }
        
        .notes-section h3::before {
            content: 'üìù';
        }
        
        .note-item {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #ffa726;
            position: relative;
        }
        
        .responsibilities {
            display: flex;
            gap: 30px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .resp-column {
            flex: 1;
            min-width: 300px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            background: white;
        }
        
        .resp-header {
            padding: 25px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }
        
        .flash-header {
            background: linear-gradient(135deg, #4caf50, #388e3c);
        }
        
        .client-header {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }
        
        .resp-content {
            padding: 25px;
        }
        
        .resp-item {
            margin: 15px 0;
            padding: 18px;
            background: #f9f9f9;
            border-radius: 10px;
            border-left: 5px solid;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .resp-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .flash-item {
            border-left-color: #4caf50;
        }
        
        .client-item {
            border-left-color: #ff9800;
        }
        
        .add-resp-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 15px;
            width: 100%;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .add-resp-btn:hover {
            background: linear-gradient(135deg, #20c997, #17a085);
            transform: translateY(-2px);
        }
        
        .approval-section {
            margin: 50px 0;
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #f5f5f5, #eeeeee);
            border: 4px dashed #2c5aa0;
            border-radius: 20px;
            position: relative;
        }
        
        .approval-section::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 30px;
            opacity: 0.3;
        }
        
        .approval-section h3 {
            color: #2c5aa0;
            font-size: 28px;
            margin-bottom: 40px;
            font-weight: 700;
        }
        
        .signature-line {
            border-bottom: 4px solid #2c5aa0;
            width: 450px;
            margin: 40px auto;
            height: 80px;
            background: linear-gradient(to right, transparent 0%, #f0f8ff 50%, transparent 100%);
        }
        
        .footer {
            margin-top: 50px;
            padding: 30px;
            border-top: 4px solid #2c5aa0;
            font-size: 13px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }
        
        .footer div {
            margin: 10px 0;
            padding: 5px 0;
        }
        
        .footer strong {
            color: #2c5aa0;
            font-weight: 700;
        }
        
        .editable {
            background: linear-gradient(135deg, #fffbf0, #fff8e1);
            border: 2px solid #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            min-height: 20px;
            cursor: text;
            position: relative;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .editable:hover {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-color: #2c5aa0;
            box-shadow: 0 2px 8px rgba(44,90,160,0.2);
        }
        
        .editable:focus {
            background: white !important;
            outline: none;
            border-color: #2c5aa0 !important;
            box-shadow: 0 0 0 3px rgba(44,90,160,0.2) !important;
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 15px;
            float: right;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .delete-btn:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            min-width: 200px;
        }
        
        .controls h4 {
            margin: 0 0 15px 0;
            color: #2c5aa0;
            font-size: 16px;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }
        
        .btn-print { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .btn-save { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-load { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .btn-add { background: linear-gradient(135deg, #20c997, #17a085); color: white; }
        .btn-calc { background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; }
        .btn-word { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }
        /* Nuovo stile per il pulsante HTML */
        .btn-html-export { background: linear-gradient(135deg, #6c757d, #495057); color: white; }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 2001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(10px);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        /* CORREZIONI PDF - STILI OTTIMIZZATI PER LA STAMPA */
        @media print {
            * { 
                -webkit-print-color-adjust: exact !important; 
                color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }
            
            body { 
                background: white !important; 
                font-size: 9pt !important;
                line-height: 1.3 !important;
                margin: 0 !important;
                padding: 0 !important;
                color: #000 !important;
            }
            
            .controls, .delete-btn, .notification, .add-resp-btn { 
                display: none !important; 
            }
            
            .document { 
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 8mm !important;
                margin: 0 !important;
                max-width: none !important;
                min-height: auto !important;
            }

            /* HEADER OTTIMIZZATO PER LA STAMPA */
            .header {
                display: block !important;
                width: 100% !important;
                background: #f8fafc !important;
                border: 2px solid #2c5aa0 !important;
                margin: 0 0 10mm 0 !important;
                padding: 8mm !important;
                page-break-after: avoid !important;
                break-inside: avoid !important;
                border-radius: 0 !important;
                position: relative !important;
                overflow: visible !important;
            }

            .logo-section {
                display: block !important;
                width: 100% !important;
                margin-bottom: 8mm !important;
                text-align: center !important;
            }

            .logo {
                width: 80px !important;
                height: 60px !important;
                margin: 0 auto 5mm auto !important;
                display: inline-block !important;
                vertical-align: top !important;
                border: 2px solid #2c5aa0 !important;
                background: #667eea !important;
            }

            .company-info {
                text-align: center !important;
                width: 100% !important;
                margin: 0 !important;
            }

            .company-info h1 {
                font-size: 18pt !important;
                margin: 0 0 3mm 0 !important;
                color: #2c5aa0 !important;
            }

            .company-info .tagline {
                font-size: 8pt !important;
                background: #e3f2fd !important;
                border-left: 3px solid #2196f3 !important;
                margin: 3mm 0 !important;
                padding: 3mm !important;
                display: inline-block !important;
            }

            /* DOCUMENT INFO POSIZIONATO CORRETTAMENTE */
            .document-info {
                position: absolute !important;
                top: 8mm !important;
                right: 8mm !important;
                width: 50mm !important;
                max-width: 50mm !important;
                background: white !important;
                border: 1px solid #ddd !important;
                padding: 5mm !important;
                font-size: 7pt !important;
                box-shadow: none !important;
                text-align: right !important;
            }

            .document-info div {
                margin: 1mm 0 !important;
                padding: 0 !important;
                line-height: 1.2 !important;
            }

            .section {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                margin: 5mm 0 !important;
                padding: 5mm !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .section h3 {
                font-size: 11pt !important;
                margin-bottom: 3mm !important;
                color: #2c5aa0 !important;
            }

            .info-grid {
                display: table !important;
                width: 100% !important;
                border-collapse: collapse !important;
            }

            .info-grid label,
            .info-grid .editable {
                display: table-cell !important;
                padding: 2mm !important;
                border: 1px solid #ddd !important;
                vertical-align: top !important;
            }

            .info-grid label {
                width: 30% !important;
                background: #f0f0f0 !important;
                font-weight: bold !important;
            }

            .conditions-grid {
                display: block !important;
                columns: 2 !important;
                column-gap: 5mm !important;
            }

            .quotation-table {
                box-shadow: none !important;
                border: 2px solid #2c5aa0 !important;
                font-size: 7pt !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin: 5mm 0 !important;
                width: 100% !important;
            }

            .quotation-table th {
                background: #2c5aa0 !important;
                color: white !important;
                padding: 3mm !important;
                font-size: 8pt !important;
            }

            .quotation-table td {
                padding: 2mm !important;
                border: 1px solid #ddd !important;
                font-size: 7pt !important;
            }

            .section-header-cell {
                background: #e3f2fd !important;
                color: #1976d2 !important;
                font-weight: bold;
                text-align: center;
                padding: 3mm !important;
            }

            .responsibilities {
                display: table !important;
                width: 100% !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin: 5mm 0 !important;
            }

            .resp-column {
                display: table-cell !important;
                width: 50% !important;
                vertical-align: top !important;
                border: 1px solid #ddd !important;
                padding: 0 !important;
            }

            .resp-header {
                background: #2c5aa0 !important;
                color: white !important;
                padding: 3mm !important;
                font-size: 9pt !important;
            }

            .resp-content {
                padding: 3mm !important;
            }

            .resp-item {
                margin: 2mm 0 !important;
                padding: 2mm !important;
                border-left: 3px solid #ddd !important;
                background: #f9f9f9 !important;
            }

            .approval-section {
                border: 2px dashed #2c5aa0 !important;
                padding: 8mm !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                text-align: center !important;
                margin: 8mm 0 !important;
            }

            .signature-line {
                border-bottom: 2px solid #000 !important;
                width: 60mm !important;
                height: 10mm !important;
                margin: 5mm auto !important;
            }

            .footer {
                border-top: 2px solid #2c5aa0 !important;
                padding: 5mm !important;
                font-size: 6pt !important;
                text-align: center !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .note-item {
                margin: 2mm 0 !important;
                padding: 3mm !important;
                border-left: 3px solid #ffa726 !important;
                background: white !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            @page { 
                margin: 10mm 8mm !important; 
                size: A4 portrait !important;
            }
        }
    </style>
</head>
<body>

    <div class="notification" id="notification"></div>

    <div class="controls">
        <h4>‚ö° FLASH CONTROL</h4>
        
        <button class="btn btn-print" onclick="generatePDF()">
            üñ®Ô∏è PDF STAMPA
        </button>
        <button class="btn btn-print" onclick="browserPrint()">
            üñ®Ô∏è STAMPA BROWSER  
        </button>
        <button class="btn btn-word" onclick="exportToWordCloudConvert()">
            üìÑ EXPORT WORD (CloudConvert)
        </button>
        <button class="btn btn-html-export" onclick="exportSimpleHTML()">
            üíæ ESPORTA HTML (per Pandoc)
        </button>
        
        <hr style="margin: 15px 0; border: 1px solid #e0e0e0;">
        
        <button class="btn btn-save" onclick="handleSave()">
            üíæ SALVA OFFERTA
        </button>
        <button class="btn btn-load" onclick="handleLoad()">
            üìÇ RECUPERA OFFERTA
        </button>
        
        <hr style="margin: 15px 0; border: 1px solid #e0e0e0;">
        
        <button class="btn btn-add" onclick="addTableRow()">
            ‚ûï AGGIUNGI RIGA
        </button>
        <button class="btn btn-calc" onclick="calculateTotal()">
            üßÆ CALCOLA TOTALE
        </button>
        <button class="btn btn-add" onclick="addNote()">
            üìù AGGIUNGI NOTA
        </button>
        
        <hr style="margin: 15px 0; border: 1px solid #e0e0e0;">
        
        <button class="btn" onclick="editTagline()" style="background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white;">
            ‚úèÔ∏è MODIFICA TAGLINE
        </button>
    </div>

    <div class="document">
        <div class="header">
            <div class="logo-section">
                <div class="logo" id="logoContainer" onclick="changeLogo()">
                    <img id="logoImage" src="" alt="Logo Aziendale">
                    <div id="logoText">FLASH<br>CONTROL Srl</div>
                </div>
                <div class="company-info">
                    <h1>FLASH CONTROL Srl</h1>
                    <div class="tagline" onclick="editTagline()">
                        SISTEMA AVANZATO PREVENTIVI<br>
                        CND - PWHT - TRATTAMENTI TERMICI LOCALIZZATI
                    </div>
                </div>
            </div>
            <div class="document-info">
                <div>
                    <strong>Codice Pratica</strong> 
                    <select class="editable" id="codicePraticaSelect" onchange="handleCodicePraticaChange()"></select>
                </div>
                <div><strong>DATE</strong> <span class="editable" contenteditable="true">2024-06-13</span></div>
                <div><strong>Numero Commessa</strong> <span class="editable" id="numeroCommessa" contenteditable="true"></span></div>
                <div><strong>VALID UNTIL</strong> <span class="editable" contenteditable="true">2024-09-13</span></div>
            </div>
        </div>

        <div class="section client-section">
            <h3>INFORMAZIONI CLIENTE</h3>
            <div class="info-grid">
                <label>Azienda:</label>
                <select class="editable" id="aziendaSelect" onchange="handleAziendaChange()"></select>
                <label>Referente:</label>
                <div class="editable" contenteditable="true">Mr. Ciraolo</div>
                <label>Email:</label>
                <div class="editable" contenteditable="true">info@aimservice.it</div>
                <label>Telefono:</label>
                <div class="editable" contenteditable="true">+39 02 1234567</div>
            </div>
        </div>

        <div class="section reference-section">
            <h3>RIFERIMENTI PROGETTO</h3>
            <div class="info-grid">
                <label>Vs. Rif.:</label>
                <div class="editable" contenteditable="true">RdO dated 21 June 2024</div>
                <label>Oggetto:</label>
                <div class="editable" contenteditable="true">QUOTATION FOR EXECUTION OF PRE/POST HEATING AND LOCALIZED PWHT IN EGYPT (GIZA), ON WELDING JOINTS DESCRIBED IN YOUR REQUEST</div>
                <label>Descrizione sintetica attivit√† da svolgere:</label> <div class="editable" contenteditable="true">Inserire qui una breve descrizione delle attivit√† da svolgere</div>
                <label>Localit√†:</label>
                <div class="editable" contenteditable="true">Giza, Egypt</div>
                <label>Tempistiche:</label>
                <div class="editable" contenteditable="true">Da definire in base alla conferma d'ordine</div>
            </div>
        </div>

        <div class="section conditions-section">
            <h3>CONDIZIONI COMMERCIALI</h3>
            <div class="conditions-grid">
                <div>
                    <strong>VALIDIT√Ä PREVENTIVO:</strong><br>
                    <div class="editable" contenteditable="true">90 GIORNI dalla data di emissione</div>
                </div>
                <div>
                    <strong>MODALIT√Ä PAGAMENTO:</strong><br>
                    <div class="editable" contenteditable="true">100% after 30 days from date of invoice</div>
                </div>
                <div>
                    <strong>TERMINI CONSEGNA:</strong><br>
                    <div class="editable" contenteditable="true">5-7 giorni lavorativi dalla conferma</div>
                </div>
                <div>
                    <strong>VALUTA:</strong><br>
                    <div class="editable" contenteditable="true">Euro (‚Ç¨) - IVA esclusa</div>
                </div>
            </div>
        </div>

        <table class="quotation-table">
            <thead>
                <tr>
                    <th>POS.</th>
                    <th>DESCRIZIONE DETTAGLIATA</th>
                    <th>QT√Ä</th>
                    <th>PREZZO UNITARIO</th>
                    <th>TOTALE</th>
                </tr>
            </thead>
            <tbody id="quotationTableBody">
                <tr>
                    <td colspan="5" class="section-header-cell">
                        <div class="editable" contenteditable="true">SERVIZI DI TRATTAMENTO TERMICO SPECIALIZZATO</div>
                    </td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>
                        <div class="editable" contenteditable="true"><strong>Servizio Tecnico Specializzato:</strong> Maximum 10 hours per day ‚Äì Maximum 6 days per week.</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">1 gg</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">720,00</div>
                        <button class="delete-btn" onclick="deleteRow(this)">‚úï</button>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">720,00</div>
                    </td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>
                        <div class="editable" contenteditable="true"><strong>Noleggio Attrezzature:</strong> DAILY PRICE FOR EQUIPMENT DULY CALIBRATED.</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">1 gg</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">160,00</div>
                        <button class="delete-btn" onclick="deleteRow(this)">‚úï</button>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">160,00</div>
                    </td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>
                        <div class="editable" contenteditable="true"><strong>Materiali di Consumo:</strong> CONSUMABLE MATERIALS per l'esecuzione dei trattamenti termici</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">1 set</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">80,00</div>
                        <button class="delete-btn" onclick="deleteRow(this)">‚úï</button>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">80,00</div>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="section notes-section">
            <h3>NOTE IMPORTANTI E CONDIZIONI SPECIALI</h3>
            <div id="notesContainer">
                <div class="note-item">
                    <strong>Lavoro Straordinario:</strong>
                    <div class="editable" contenteditable="true">In case of working in overtime the prices will be increased of 10%</div>
                    <button class="delete-btn" onclick="deleteNote(this)">‚úï</button>
                </div>
                <div class="note-item">
                    <strong>Turno Notturno:</strong>
                    <div class="editable" contenteditable="true">In case of working in night shift the prices will be increased of 15%</div>
                    <button class="delete-btn" onclick="deleteNote(this)">‚úï</button>
                </div>
            </div>
        </div>

        <div class="responsibilities">
            <div class="resp-column">
                <div class="resp-header flash-header">
                    OBBLIGHI FLASH CONTROL SRL
                </div>
                <div class="resp-content" id="flashResponsibilities">
                    <div class="resp-item flash-item">
                        <strong>Personale Qualificato:</strong>
                        <div class="editable" contenteditable="true">Skilled personnel with international certifications</div>
                        <button class="delete-btn" onclick="deleteResponsibilityItem(this)">‚úï</button>
                    </div>
                    <div class="resp-item flash-item">
                        <strong>Attrezzature Certificate:</strong>
                        <div class="editable" contenteditable="true">PWHT instruments with valid calibration certificates</div>
                        <button class="delete-btn" onclick="deleteResponsibilityItem(this)">‚úï</button>
                    </div>
                    <div class="resp-item flash-item">
                        <strong>Procedure Operative:</strong>
                        <div class="editable" contenteditable="true">Standard operating procedures and safety protocols</div>
                        <button class="delete-btn" onclick="deleteResponsibilityItem(this)">‚úï</button>
                    </div>
                </div>
                <button class="add-resp-btn" onclick="addFlashResponsibility()">‚ûï Aggiungi Obbligo Flash Control</button>
            </div>

            <div class="resp-column">
                <div class="resp-header client-header">
                    RESPONSABILIT√Ä CLIENTE
                </div>
                <div class="resp-content" id="clientResponsibilities">
                    <div class="resp-item client-item">
                        <strong>Ordine Ufficiale:</strong>
                        <div class="editable" contenteditable="true">Formal purchase order with technical specifications</div>
                        <button class="delete-btn" onclick="deleteResponsibilityItem(this)">‚úï</button>
                    </div>
                    <div class="resp-item client-item">
                        <strong>Ponteggi e Accessi:</strong>
                        <div class="editable" contenteditable="true">Scaffolding and safe access to all work areas</div>
                        <button class="delete-btn" onclick="deleteResponsibilityItem(this)">‚úï</button>
                    </div>
                    <div class="resp-item client-item">
                        <strong>Alimentazione Elettrica:</strong>
                        <div class="editable" contenteditable="true">Adequate electricity supply (380V, 50Hz, min 32A)</div>
                        <button class="delete-btn" onclick="deleteResponsibilityItem(this)">‚úï</button>
                    </div>
                </div>
                <button class="add-resp-btn" onclick="addClientResponsibility()">‚ûï Aggiungi Responsabilit√† Cliente</button>
            </div>
        </div>

        <div class="approval-section">
            <h3>APPROVAZIONE E ACCETTAZIONE CLIENTE</h3>
            <p style="color: #666; margin-bottom: 30px;">
                Con la firma del presente preventivo, il Cliente accetta integralmente le condizioni specificate,
                i termini di pagamento e le responsabilit√† indicate.
            </p>
            <div class="signature-line"></div>
            <div style="margin-top: 15px; font-weight: bold; color: #2c5aa0;">
                Firma del Cliente e Timbro Aziendale
            </div>
            <div style="margin-top: 30px; font-size: 12px; color: #666;">
                Data: _________________ &nbsp;&nbsp;&nbsp; Luogo: _________________
            </div>
        </div>

        <div class="footer">
            <div><strong>Sede Legale:</strong> <span class="editable" contenteditable="true">Via della Stazione di San Pietro 65 - 00165 Roma (RM)</span></div>
            <div><strong>Telefono:</strong> <span class="editable" contenteditable="true">+39 0547 373024</span> - <strong>Fax:</strong> <span class="editable" contenteditable="true">+39 0547 323119</span></div>
            <div><strong>Email:</strong> <span class="editable" contenteditable="true">info@flashcontrol.it</span> <strong>PEC:</strong> <span class="editable" contenteditable="true">info@pec.flashcontrol.it</span></div>
            <div><strong>P.IVA:</strong> <span class="editable" contenteditable="true">15815591001</span> - <strong>C.F.:</strong> <span class="editable" contenteditable="true">15815591001</span></div>
            <div style="margin-top: 15px; font-size: 11px; color: #888;">
                Documento generato dal Sistema Flash Control v2.1 - ¬© 2024 Flash Control S.r.l.
            </div>
        </div>
    </div>

    <script>
        // ================================
        // SISTEMA FLASH CONTROL v2.1 CON CLOUDCONVERT
        // ================================
        
        // ATTENZIONE: Questa API Key √® ESPOSTA nel frontend.
        // Per un'applicazione in produzione, considera di usare un backend
        // per gestire le chiamate a CloudConvert in modo sicuro.
        const CLOUDCONVERT_API_KEY = 'YOUR_CLOUDCONVERT_API_KEY_HERE'; // Replace with your actual API key
        const CLOUDCONVERT_BASE_URL = 'https://cloudconvert.com';
        
        let rowCounter = 3; /* Questa variabile verr√† aggiornata dalla funzione renumberTableRows */
        
        // Global variables to store parsed CSV data
        let parsedCsvData = [];
        let praticaDataMap = new Map(); // Map RIF.PRATICA to its full row data
        let uniqueClienti = new Set(); // Set of unique client names

        // CSV content embedded directly from the provided file
        // MODIFICATO: Contenuto CSV con punto e virgola come delimitatore
        const csvContent = ` ;;;;Livello Documento: Modulo;;;;;PC;
;;;; PROTOCOLLO COMMESSE;;;;;00;
;;;;;;;;;;
N¬∞ Offerta;Data Offerta;Cliente;RIF.PRATICA;Esito Ordine;N¬∞ di Commessa;n¬∞ Ordine;Descrizione lavoro;Luogo di lavoro;Note;
1.0;45659.0;SAIPEM;25001FLC;POSITIVO;25001FLC;5000042590;Bid Doc584733093 - RFQ 6001615411 - CONTROLLI NON DISTRUTTIVI - PR 11692627 ;Arbatax-Macchiareddu;CONVENZIONE EX COMMESSA 21044FLC & 23082FLC & 24009FLC;
2.0;45659.0;LILIANA;25002FLC;POSITIVO;25002FLC;;TT SOLUBILIZZAZIONE E CND VARI;PRESSO NS.
e LORO SEDE A PAVIA;EX COMMESSA 21402FLC & 23098FLC & 24010FLC - REV.
PREZZI PER 2025;
3.0;45659.0;NDT SICILY;25003FLC;POSITIVO;25003FLC;;Prestazione tecnici;;EX COMMESSA 20072FLC & 23090FLC & 24014FLC;
4.0;45659.0;ALPERIA;25004FLC;POSITIVO;25004FLC;3679 & 3683;Accordo quadro x Controlli distruttivi e non ;C.li idroelettriche Vipower e Greenpower;GARE 10023921+10023928 (ex commessa 23127FLC & 24015FLC);
5.0;45659.0;DOLOMITI ENERGIA;25005FLC;POSITIVO;25005FLC;4300003515;GARA CND CONDOTTE FORZATE;VARIE CENTRALI TRENTINO A.A.;EX COMMESSA 22317FLC & 23109FLC & 24016FLC;
6.0;45659.0;TECNOMEC ENGINEERING;25006FLC;POSITIVO;25006FLC;688/22;PWHT FORNO GENERICA;TARANTO;EX 22088FLC & 23219FLC & 24019FLC;
7.0;45659.0;CARPENTERIA CORSI;25007FLC;POSITIVO;25007FLC;;PWHT FORNO;MASSA & SARZANA; EX COMMESSA 23092FLC & 23093FLC & 24021FLC;
8.0;45659.0;SBM IRFI;25008FLC;POSITIVO;25008FLC;;GENERICA PER INFORNATE;Pian Camuno;EX COMMESSA 21063FLC & 23121FLC & 24022FLC (invio anche di offerta per proluna forno);
9.0;45659.0;OFFICINE RAM POWER;25009FLC;POSITIVO;25009FLC;24/00092 ;PWHT in forno e localizzati su piping in P11;loro sede Ravenna e ns.
 sede FC;EX COMMESSA 23152FLC & 24023FLC;
10.0;45659.0;OCS S.p.A.;25010FLC;POSITIVO;25010FLC;;Commessa generica OCS ;FORNO PADOVA;ex COMMESSA 08105FTC e 20051FLC e 23086FLC & 24024FLC - rev.1 nuovo prezziario;
11.0;45659.0;TECNO SERVICE srl;25011FLC;POSITIVO;25011FLC;208;CND GENERICI; loro aree Lomello (PV);EX COMMESSA 23217FLC & 24012FLC;
12.0;45659.0;SACMI;25012FLC;POSITIVO;25012FLC;;Trattamenti termici manufatti;forno sede San Vittore;EX COMMESSA 20055FLC & 23123FLC 24025FLC;
13.0;45659.0;PELFA;25013FLC;POSITIVO;25013FLC;1473 (RTS);ORDINE GENERICO PWHT FORNO;SEDE SAN VITTORE;EX COMMESSA 13078RTF & 21036FLC & 23094FLC & 24026FLC;
14.0;45660.0;PARESA S.p.A.;25014FLC;POSITIVO;25014FLC;APPALTO 2021-101-1195 REV.3;"PWHT, CND, DIGITALIZZAZIONE FILM";Gualdo + ns sede Mercato;EX COMMESSA 21006FLC + 22332FLC + 23091FLC & 24032FLC;
15.0;45660.0;BABBINI;25015FLC;POSITIVO;25015FLC;ordini vari per consegna alberi;INFORNATE + CND ALBERI ;forno sede San Vittore;"COMMESSA GENERICA PASSATA DA RTS DAL 01.12.2020 AL NR.
 20037FLC, POI 23085FLC & 24031FLC";
16.0;45660.0;OFFICINE DEL SAVIO;25016FLC;POSITIVO;25016FLC;offerta firmata;GENERICA PER CND+INFORNATE SEDE;"CND c/o Gualdo, infornate c/o ns.
 sede";EX COMMESSA 21012FLC+ 23122FLC +24033FLC;
17.0;45660.0;SACIM;25017FLC;POSITIVO;25017FLC;;CND;loro aree Cesena;EX COMMESSA 17104NFC & 21052FLC & 23096FLC;
18.0;45660.0;ALFA LAVAL;25018FLC;POSITIVO;25018FLC;;Eddy current ;Israele;;
19.0;45664.0;INSPECTA;25019FLC;positivo;25019FLC;;PAUT SERBATOI;ANVERSA- BELGIO;CONTATTO DA PARESA-  EX COMMESSA 24151FLC;
20.0;45664.0;TOSCOTEC;25020FLC;POSITIVO;25020FLC;ALL. D contratto;GENERICA PER PWHT in FORNO;STABILIMENTO MASSA;ex COMMESSA 14188RTF e 20070FLC e 23089FLC & 24027FLC;
21.0;45666.0;BREMBANA E ROLLE;25021FLC;POSITIVO;25021FLC;;COMMESSA GENERICA+ VENDITA BLOCCHI REFRATTARI PER PLATEA;MARGHERA;EX COMMESSA 14205RTF & 21038FLC & 23095FLC & 24029FLC;
22.0;45666.0;Cannon Artes S.p.A. ;25022FLC;POSITIVO;25022FLC;;PWHT in forno+ sporadici localizzati;loro aree;EX COMMESSA 21208FLC & 23139FLC & 24030FLC;
23.0;45667.0;COMCE;25023FLC;POSITIVO;25023FLC;66 & 237 & 1036-24;generica per PWHT forno e CND + RT su serpentini;PRESSO NS.  e LORO SEDE A CESENA;EX COMMESSA 22011FLC & 23099FLC & 24034FLC & 24119FLC;
24.0;45667.0;VECOMONT;25024FLC;attesa;;;RADIOGRAFIE SU LINEE;;RIF.
 EX COMMESSA 24011FLC;
25.0;45671.0;FORGIA DI BOLLATE;25025FLC;POSITIVO;24025FLC;2225000038; N. 1+1 Campana chiusa con predisposizione per bruciatori dimensione esterna mt 8.00x6.00x4.00 ; plant di Canneto;rif.
 pratica 24207FLC;
26.0;45671.0;GE VERNOVA;25026FLC;attesa;;;NDT and Welding Services for Janub project;Azerbaijan;rev.1 -divisa per unit√† di lavoro;
27.0;45672.0;  T.G.E.
 Ventilatori S.r.l.;25027FLC;POSITIVO;25027FLC;;CND su ventilatori e giranti;loro aree;EX COMMESSA 23235FLC +24060FLC;
28.0;45672.0;FIRE TECHNOLOGY;25028FLC;positivo;25028FLC;accettazione offerta;OFFERTA GENERICA;;ex COMMESSA 23279FLC + 24149FLC;
29.0;45672.0;ROSETTI MARINO;25029FLC;POSITIVO;25029FLC;122A70-SDA-10438 ;LPWHT su piping;aree Ravenna;"rev,2";
30.0;45672.0;"
EnPlus S.r.l.";25030FLC;attesa;;;RT-LP- PRERISCALDI + LPWHT su 3 saldature di valvole di sicurezza di caldaia NooterEriksen;Enplus San Severo (FG);;
31.0;45673.0;GE VERNOVA - FIELDCORE GREEK BRANCH;25031FLC;POSITIVO;25031FLC;4900460140+4900460144 +4900460333;CND su vari componenti;GRECIA;RIF.
 PRATICA 24204FLC + ADDENDUM ORDINE 4900460333;
32.0;45674.0;TUBITAL;25032FLC;PERSO;;;LPWHT su circolare di curva apparecchio;aree Marghera;;
33.0;45677.0;OFF.
 RAM POWER;25033FLC;POSITIVO;25033FLC;25/00078;controlli VT per CP2;RAVENNA;EX COMMESSA 24160FLC;
34.0;45677.0;OFFICINE RESTA;25034FLC;attesa;;;LPWHT su 2 saldature;loro sede Marghera;LAVORI FINE ESTATE 2025;
35.0;45677.0;F.LLI AMADUCCI;25035FLC;attesa;;;PWHT AC su apparecchi;loro aree Bertinoro;;
36.0;45677.0;QUALITY TEST;25036FLC;POSITIVO;25036FLC;;GENERICA PER TECNICI CND/PWHT;loro sede Ravenna o altre sedi;EX COMMESSA 22286FLC & 23110FLC & 24059FLC;
37.0;45677.0;NDT AND INSPECTION;25037FLC;POSITIVO;25037FLC;;PRESTAZIONI TECNICI VARIE;;EX COMMESSA 24068FLC;
38.0;45677.0;CMP;25038FLC;positivo;25038FLC;vari ordini per PWHT;trattamenti termici in forno;officina Bottrighe;RIF.
 EX COMMESSA 21043FLC + 23199FLC +24097FLC;
39.0;45677.0;SAIPEM ;25039FLC;POSITIVO;25039FLC;31619818;Progetto IRPA;CANTIERE CAGLIARI;EX COMMESSA 24171FLC;
40.0;45679.0;MODOMEC;25040FLC;attesa;;;PWHT AC su colonna;loro aree Taranto;;
41.0;45680.0;RFTS TECHNOLOGIES;25041FLC;POSITIVO;25041FLC;;PRESTAZIONE TECNICO ESPERTO UT;NIGERIA;EX COMMESSA 23154FLC+ 24020FLC;
42.0;45680.0;SIMIC S.p.A.;25042FLC;POSITIVO;25042FLC;2400054_L ;FORNO 8X6X22 + VENDITA MODULI REFRATTARI;LORO AREE;EX COMMESSA 23282FLC +24045FLC;
43.0;45680.0;CARPENTERIA CORSI;25043FLC;PERSO;;;"LPWHT su saldatura circolare del fondo;";loro aree;;
44.0;45681.0;NEW ENERGY;25044FLC;POSITIVO;25044FLC;;CND VARI;LORO AREE;ex COMMESSA 24110FLC;
45.0;45681.0;TUBITAL;25045FLC;positivo;25045FLC;23054;GESTIONE CICLI TERMICI ;C/O LORO AREE;ex COMMESSA 23002FLC+ 24150FLC;
46.0;;MANUTENZIONI INERENTI FORNI;25900FLC;POSITIVO;25900FLC;;manutenzioni generiche pannellatura e strutture ;magazzino;ex COMMESSA 24900FLC;
47.0;45681.0;BREMBANA E ROLLE;25046FLC;positivo;25046FLC;23031-ODA24-004223;"1 saldatura circonferenziale mantello, tra virole pos.201-220 √òi2540mm, sp.130mm"; Ricengo;EX COMMESSA 24209FLC;
48.0;45681.0;TRATENOR;25047FLC;POSITIVO;25047FLC;;PWHT e servizi accessori;;EX COMMESSA 23049FLC+ 24013FLC;
49.0;45681.0;BREMBANA E ROLLE;25048FLC;positivo;25048FLC;23060-ODA24-003957;LPWHT SU CIRCOLARE TRA MANTELLO e PIASTRA TUBIERA;LORO AREE ALBIGNASEGO;EX COMMESSA 24196FLC;
50.0;45684.0;TECNO REFRACTORIES;25049FLC;attesa;;;DRY OUT SU APPARECCHIO;OFFICINA MARGHERA;chiamato 
 Vigan√≤ da Franco;
51.0;45684.0;ALFA LAVAL;25050FLC;POSITIVO;25050FLC;a consuntivo;TECNICO X ULTRASUONI ;OMAN;;
52.0;45687.0;ALFA LAVAL;25051FLC;POSITIVO;25051FLC;a consuntivo;PRERISCALDI ;SUISIO (BG);EX COMMESSA 24189FLC;
53.0;45687.0;SIMIC S.p.A.;25052FLC;;;;Forno a Campana con movimentazione con Gru semovente ;loro aree Marghera;;
54.0;45688.0;OCS S.p.A.;25053FLC;attesa;;;LPWHT su saldature circonferenziali mantello/fondo;c/o LORO AREE;;
55.0;45692.0;CAM IMPIANTI;25054FLC;POSITIVO;25054FLC;ORDINE GENERICO;CONTRATTO ANNUALE 2025;;VECCHIA COMMESSA 24082FLC;
56.0;45692.0;IWN SRL;25055FLC;POSITIVO;25055FLC;mail conferma;RISCALDAMENTO TUBAZIONE;MARGHERA;;
57.0;45693.0;BREMBANA E ROLLE;25056FLC;POSITIVO;;25-000403;LPWHT SU SALDATURE CIRCONFERENZIALI;MARGHERA;loro commessa 23069;
58.0;45699.0;SAIPEM;25057FLC;NEGATIVO;;;PMI ;MARGHERA;PASSATA A NDT AND INSPECTION;
59.0;45699.0;CHRISTOF GROUP;25058FLC;attesa;;;ET+VT+PT+UT;BRAZILE;;
60.0;45700.0;CMC SUD;25059FLC;POSITIVO;25059FLC;2.449/25;CND;AVENZA;;
61.0;45700.0;CARP.
 CORSI;25060FLC;attesa;;;VT+PT+MT su cassoni portapinne;sede di Castelnuovo Magra;vogliono quotazione a corpo;
62.0;45700.0;CARP.
 CORSI;25061FLC;POSITIVO;25061FLC;;PWHT di 4 giranti;sede di Castelnuovo Magra;;
63.0;45701.0;MAX STREICHER;25062FLC;attesa;;;LPWHT + EVENTUALE FORNO;STOGIT FIUME TRIESTE;;
64.0;45702.0;INCO INTERNATIONAL FZCO;25063FLC;POSITIVO;25063FLC;INI422-SUB-PWHT-003;PWHT COMBUSTIONE INTERNA SFERA ;ABU DHABI;ex COMMESSA 24176FLC;
65.0;45702.0;INDUSTROREMONT d.o.o;25064FLC;;;;CND IN SITO;CORTEOLONA (PV) PLANT;;
;45702.0;OFAR;25065FLC;POSITIVO;25065FLC;2125001839.0;LPWHT SU CORNA SALDATE SU PIANO PRESSA;LORO AREE;;
67.0;45705.0;OCS S.p.A.;25066FLC;attesa;;;PWHT AC SERBATOI + LOC.
 TRONCHI;LORO AREE;RIF. VECCHIA PRATICA 20063FLC (vedi risp. Cangini);
68.0;45706.0;ETI SPA;25067FLC;POSITIVO;25067FLC;001OL/2019;CND SU ADDUTTORE;SPELLO (PG);EX COMMESSA 23125FLC + 24007FLC;
69.0;45707.0;OFRA;25068FLC;attesa;;;PWHT IN FORNO ;ns aree;;
70.0;45707.0;GE VERNOVA-FIELDCORE;25069FLC;POSITIVO;25069FLC;4900470625 ;NDT ON FPI IN LOAD COUPLING;AGIOS NICOLAOS - GREECE;;
71.0;45708.0;GRUPPO ANTONINI ENERGY SRL;25070FLC;POSITIVO;25070FLC;560/GE/C56;PWHT in forno su separatori e ricevitori;loro aree;;
72.0;45708.0;CMC SUD;25071FLC;POSITIVO;25071FLC;2.450/25;PAUT-UT ;SCHIO;;
73.0;45709.0;PRISMA SRL;25072FLC;POSITIVO;25072FLC;offerta firmata;OFFERTA GENERICA;loro aree;;
74.0;45712.0;COIM;25073FLC;attesa;;;OFFERTA GENERICA;loro aree;;
75.0;45713.0;NAPOLITANO INOX;25074FLC;attesa;;;OFFERTA GENERICA;LORO AREE;;
76.0;45715.0;PELFA;25075FLC;attesa;;;LPWHT SU CIRCOLARI ;LORO AREE A BUJA (UD);;
77.0;45721.0;OCIS;25076FLC;POSITIVO;25076FLC;6701 / 1687 / 25;OFFERTA GENERICA;LORO AREE;;
78.0;45721.0;ATB Riva Calzoni;25077FLC;positivo;25077FLC;8406;Forno per PWHT su 3 biforcazioni;area portuale in Colombia;rif.
 pratica 24210FLC;
79.0;45723.0;ATB Riva Calzoni- Christof Group;25078FLC;POSITIVO;25078FLC;42250220.0;preriscaldi e LPWHT per la realizzazione e dopo la riparazione di un anello interno ad un reattore ;Grecia;RIF.
 PRATICA 24197FLC;
80.0;45726.0;WALTER TOSTO;25079FLC;attesa;;;PWHT AC su 4 sfere di stoccaggio;ANTWERP- BELGIO;;
81.0;45726.0;TECNO REFRACTORIES;25080FLC;attesa;;;DRY OUT REFRATTARIO DI TERMOVALORIZZATORE;FROSINONE;;
82.0;45727.0;Next Level Refractories ;25081FLC;attesa;25081FLC;approvazione via mail;DRY OUT CON RESISTENZE SU SEZIONI DI BRUCIATORI CTS;CHIETI;REV.1;
83.0;45730.0;TOSCOTEC;25082FLC;POSITIVO;25082FLC;EMESSI X CAD.
 INTERVENTO;PREZZARIO PWHT LOCALIZZATI;LORO AREE MASSA;RIF. EX PRATICHE 15104RTS e 17059RTS;
84.0;45734.0;SCRM;25083FLC;;;;FORNO 10X4X4 per PWHT SERBATOI e TALLONI;CISTERNA DI LATINA;;
85.0;45737.0;BREMBANA E ROLLE;25084FLC;POSITIVO;25084FLC;;LPWHT su saldatura di tronchetto;Marghera;;
86.0;45737.0;DONELLI;25085FLC;attesa;;;PWHT PER POLIMERIZZAZIONE DI LINING DI 1 SERBATOIO;PADOVA o MARGHERA;;
87.0;45737.0;Next Level Refractories ;25086FLC;attesa;;;DRY OUT SU REFRETTARIO;UNGHERIA;;
88.0;45743.0;CMC SUD;25087FLC;attesa;;;IRIS SU TUBI diam.
 19 mm;zona VICENZA;;
89.0;45750.0;WELDING & INSPECTION;25088FLC;POSITIVO;25088FLC;3/2025;LPWHT ;officine OFMECO;RICHIESTO ADDENDUM;
90.0;45751.0;STEEL LINE;25089FLC;POSITIVO;25089FLC;340;CND su 5 serbatoi;MONDOLFO;;
91.0;45756.0;WELDING & INSPECTION;25090FLC;POSITIVO;25088FLC; 4/2025;LPWHT;officine OFMECO;COMMESSA GENERICA 25088FLC + addendum per saldatura aggiuntiva;
92.0;45757.0;GRUPPO ANTONINI ENERGY SRL;25091FLC;POSITIVO;25091FLC;988/GE;PWHT  su 2 scambiatori;LORO AREE;;
93.0;45757.0;CATTANEO MECCANICA;25092FLC;attesa;;;LPWHT  su assieme di 3 saldature;loro sede;;
94.0;45758.0;ETI SPA;25093FLC;attesa;;;PRESTAZIONE ISPETTORE;CANTIERI VARI;/;/
95.0;45769.0;WALTER TOSTO;25094FLC;attesa;;;FORNO 12X12X36 m + PWHT di 8 storage bullet;ROMANIA;;
96.0;45770.0;CARPENTERIA CORSI;25095FLC;attesa;;;PWHT in forno di vessel Electic Heater item EH-501; Castelnuovo Magra (SP);;
97.0;45770.0;VE.DA.
 Srls;25096FLC;attesa;;;OFFERTA GENERICA CND;loro aree Pavia;;
98.0;45771.0;Bruno Presezzi ;25097FLC;attesa;;;"preriscaldi su 1 corona polare, in preparazione all‚Äôincalzatura con l‚Äôalbero";loro aree;;
99.0;45771.0;OFFICINE RESTA;25098FLC;attesa;;;LPWHT su circolare di scambiatore di calore- JOB 20/23;sede Marghera;;
100.0;45771.0;OFFICNE RESTA;25099FLC;attesa;;;LPWHT su circolare di scambiatore di calore- JOB 23/23;sede Marghera;;
101.0;45777.0;SIMIC S.p.A.;25100FLC;POSITIVO;25100FLC; 2500686-A;VENDITA CARRELLONE 400T;;carrellone acquisito da OFMECO;
102.0;45782.0;CHRISTOF GROUP;25101FLC;;;;UT su circa 940 saldature di tubi;loro aree Ternitz;;
103.0;45876.0;CARP.
 CORSI;25102FLC;POSITIVO;25102FLC;P.O. 567-066-24 REV. 1;FORNO per trattamento 2 vcessel;MASSA;rev.1;
104.0;45789.0;OFMECO PRESSURE COMPONENTS;25103FLC;POSITIVO;25103FLC;offerta firmata;RT su giunti in acciaio inox e al carbonio;loro aree;;
105.0;45824.0;FBM HUDSON;25104FLC;attesa;;;PWHT LOCALIZZATI ;LORO AREE;rev.1;
106.0;45796.0;Next Level Refractories ;25105FLC;attesa;;;DRY OUT 22 VESSEL ;ORTONA (CH);;
107.0;45796.0;OFMECO PRESSURE COMPONENTS;25106FLC;attesa;;;LPWHT SALDATURE AP5 & AP6;loro aree;;
108.0;45798.0;CND CONTROL;25107FLC;POSITIVO;25107FLC;offerta firmata;MT+VT+ certificazione;DIGA ENEL PIACENZA;;
109.0;45798.0;MECON;25108FLC;attesa;;;CND vari;ACEA SAN VITTORE LINEA 2 e 3;;
110.0;45800.0;AIM SERVICE;25109FLC;attesa;;;PREZZARIO PWHT LOCALIZZATI ;officina CASTELFRANCO VENETO;rev.1;
111.0;45804.0;CND SERVICE;25110FLC;attesa;;;intervento  tecnico + bruciatore;loro aree di Civitavecchia;;
112.0;45804.0;TERMOTECNICA INDUSTRIALE;25111FLC;attesa;;;Smagnetizzazione per Tubazioni;Cavarzere (VE);;
113.0;30/05/205;CMC SUD;25112FLC;POSITIVO;25112FLC;2490.25;TECNICI PER RT;AVENZA;rev.1;
114.0;45811.0;FIELDCORE GRECIA;25113FLC;POSITIVO;25113FLC;4900502795+4900502780+4900502913;CND POWER OUTAGE;KORINTHOS;;
115.0;45814.0;CARPENTERIA CORSI;25114FLC;POSITIVO;656/117/24 REV.
 0;"PWHT localizzato su saldatura circolare del fondo (pi√π tallone di produzione),";AREE MASSA;;
116.0;45819.0;PARESA S.p.A.;25115FLC;attesa;;;PWHT AC SU 1 SFERA;MAROCCO;;
117.0;45824.0;MODOMEC SRL;25116FLC;attesa;;;LPWHT SU REATTORE;TARANTO;;
118.0;45825.0;RAM  PER SAIPEM ;25117FLC;attesa;;;CND SU PROGETTO SAIPEM ;Ravenna ;;
119.0;45827.0;SOLESI SPA ;25118FLC;attesa;;;cnd su area ponticelle ravenna ;Ravenna;;
120.0;45827.0;AIM SERVICE;25119FLC;attesa;;;CND+PWHT;officina ARGENTA (FE);;
121.0;45831.0;SIMIC S.p.A.;25120FLC;attesa;;;LPWHT su subo P22;Polo energetico Reggio Emilia- IREN;;
122.0;45833.0;OCS S.p.A.;25121FLC;;;;PWHT circonferenziale d'unione mantello/fondo (job 207714-207715);Padova;;
123.0;;;;;;;;;;
124.0;;;;;;;;;;
125.0;;;;;;;;;;
126.0;;;;;;;;;;
127.0;;;;;;;;;;
128.0;;;;;;;;;;
129.0;;;;;;;;;;
130.0;;;;;;;;;;
131.0;;;;;;;;;;
132.0;;;;;;;;;;
133.0;;;;;;;;;;
134.0;;;;;;;;;;
135.0;;;;;;;;;;
136.0;;;;;;;;;;
137.0;;;;;;;;;;
138.0;;;;;;;;;;
139.0;;;;;;;;;;
140.0;;;;;;;;;;
141.0;;;;;;;;;;
142.0;;;;;;;;;;
143.0;;;;;;;;;;
144.0;;;;;;;;;;
145.0;;;;;;;;;;
146.0;;;;;;;;;;
147.0;;;;;;;;;;
148.0;;;;;;;;;;
149.0;;;;;;;;;;
150.0;;;;;;;;;;
151.0;;;;;;;;;;
152.0;;;;;;;;;;
153.0;;;;;;;;;;
154.0;;;;;;;;;;
155.0;;;;;;;;;;
156.0;;;;;;;;;;
157.0;;;;;;;;;;
158.0;;;;;;;;;;
159.0;;;;;;;;;;
160.0;;;;;;;;;;
161.0;;;;;;;;;;
162.0;;;;;;;;;;
163.0;;;;;;;;;;
164.0;;;;;;;;;;
165.0;;;;;;;;;;
166.0;;;;;;;;;;
167.0;;;;;;;;;;
168.0;;;;;;;;;;
169.0;;;;;;;;;;
170.0;;;;;;;;;;
171.0;;;;;;;;;;
172.0;;;;;;;;;;
173.0;;;;;;;;;;
174.0;;;;;;;;;;
175.0;;;;;;;;;;
176.0;;;;;;;;;;
177.0;;;;;;;;;;
178.0;;;;;;;;;;
179.0;;;;;;;;;;
180.0;;;;;;;;;;
181.0;;;;;;;;;;
182.0;;;;;;;;;;
183.0;;;;;;;;;;
184.0;;;;;;;;;;
185.0;;;;;;;;;;
186.0;;;;;;;;;;
187.0;;;;;;;;;;
188.0;;;;;;;;;;
189.0;;;;;;;;;;
190.0;;;;;;;;;;
191.0;;;;;;;;;;
192.0;;;;;;;;;;
193.0;;;;;;;;;;
194.0;;;;;;;;;;
195.0;;;;;;;;;;
196.0;;;;;;;;;;
197.0;;;;;;;;;;
198.0;;;;;;;;;;
199.0;;;;;;;;;;
200.0;;;;;;;;;;
201.0;;;;;;;;;;
202.0;;;;;;;;;;
203.0;;;;;;;;;;
204.0;;;;;;;;;;
205.0;;;;;;;;;;
206.0;;;;;;;;;;
207.0;;;;;;;;;;
208.0;;;;;;;;;;
209.0;;;;;;;;;;
210.0;;;;;;;;;;
211.0;;;;;;;;;;
212.0;;;;;;;;;;
213.0;;;;;;;;;;
214.0;;;;;;;;;;
215.0;;;;;;;;;;
216.0;;;;;;;;;;
217.0;;;;;;;;;;
218.0;;;;;;;;;;
219.0;;;;;;;;;;
220.0;;;;;;;;;;
221.0;;;;;;;;;;
222.0;;;;;;;;;;
223.0;;;;;;;;;;
224.0;;;;;;;;;;
225.0;;;;;;;;;;
226.0;;;;;;;;;;
227.0;;;;;;;;;;
228.0;;;;;;;;;;
229.0;;;;;;;;;;
230.0;;;;;;;;;;
231.0;;;;;;;;;;
232.0;;;;;;;;;;
233.0;;;;;;;;;;
234.0;;;;;;;;;;
235.0;;;;;;;;;;
236.0;;;;;;;;;;
237.0;;;;;;;;;;
238.0;;;;;;;;;;
239.0;;;;;;;;;;
240.0;;;;;;;;;;
241.0;;;;;;;;;;
242.0;;;;;;;;;;
243.0;;;;;;;;;;
244.0;;;;;;;;;;
245.0;;;;;;;;;;
246.0;;;;;;;;;;
247.0;;;;;;;;;;
248.0;;;;;;;;;;
249.0;;;;;;;;;;
250.0;;;;;;;;;;
251.0;;;;;;;;;;
252.0;;;;;;;;;;
253.0;;;;;;;;;;
254.0;;;;;;;;;;
255.0;;;;;;;;;;
256.0;;;;;;;;;;
257.0;;;;;;;;;;
258.0;;;;;;;;;;
259.0;;;;;;;;;;
260.0;;;;;;;;;;
261.0;;;;;;;;;;
262.0;;;;;;;;;;
263.0;;;;;;;;;;
264.0;;;;;;;;;;
259.0;;;;;;;;;;
266.0;;;;;;;;;;
267.0;;;;;;;;;;
268.0;;;;;;;;;;
269.0;;;;;;;;;;
270.0;;;;;;;;;;
271.0;;;;;;;;;;
259.0;;;;;;;;;;
273.0;;;;;;;;;;
218.0;;;;;;;;;;
275.0;;;;;;;;;;
276.0;;;;;;;;;;
277.0;;;;;;;;;;
278.0;;;;;;;;;;
279.0;;;;;;;;;;
280.0;;;;;;;;;;
281.0;;;;;;;;;;
282.0;;;;;;;;;;
283.0;;;;;;;;;;
284.0;;;;;;;;;;
285.0;;;;;;;;;;
286.0;;;;;;;;;;
287.0;;;;;;;;;;
288.0;;;;;;;;;;
289.0;;;;;;;;;;
290.0;;;;;;;;;;
291.0;;;;;;;;;;
292.0;;;;;;;;;;
293.0;;;;;;;;;;
294.0;;;;;;;;;;
295.0;;;;;;;;;;
296.0;;;;;;;;;;
297.0;;;;;;;;;;
298.0;;;;;;;;;;
299.0;;;;;;;;;;
300.0;;;;;;;;;;
301.0;;;;;;;;;;
302.0;;;;;;;;;;
303.0;;;;;;;;;;
304.0;;;;;;;;;;
305.0;;;;;;;;;;
306.0;;;;;;;;;;
307.0;;;;;;;;;;
308.0;;;;;;;;;;
309.0;;;;;;;;;;
310.0;;;;;;;;;;
311.0;;;;;;;;;;
312.0;;;;;;;;;;
313.0;;;;;;;;;;
314.0;;;;;;;;;;
315.0;;;;;;;;;;
316.0;;;;;;;;;;
317.0;;;;;;;;;;
318.0;;;;;;;;;;
319.0;;;;;;;;;;
320.0;;;;;;;;;;
321.0;;;;;;;;;;
322.0;;;;;;;;;;
323.0;;;;;;;;;;
324.0;;;;;;;;;;
325.0;;;;;;;;;;
326.0;;;;;;;;;;
;;;;;;;;;;
;;DATI COMMESSE;;;;;;;;;
;;Numero di Offerte;;182.0;;;;;;
;;Numero di Sospese;;43.0;;;;;;
;;Numero di Offerte con risposta;;139.0;;;;;;
;;Numero di Commesse;;71.0;;;;;;
;;Indice di Successo;;0.3901098901098901;;;;;;
"
Sede Legale: Via della Stazione di San Pietro 65 ‚Äì 00165 Roma  -  Sede Amm.va: Via Einstein, 16 ‚Äì 47025 Mercato Saraceno (FC)
Tel.
 +39 0547 373024  -  Fax. +39 0547 323119  -  mail: info@flashcontrol.it  -  PEC: info@pec.flashcontrol.it 
P.IVA: 15815591001  -  codice univoco: A4707H7;;;;;;;;;;
`;

        function parseCsvData(csvContent) {
            console.log("Starting parseCsvData...");
            // MODIFICATO: Correzione della riga che causava il SyntaxError
            // Questa riga rimuove i tag come , , etc.
            const cleanedCsvContent = csvContent.replace(/\/g, '').trim(); 
           // Split by newline.
            let lines = cleanedCsvContent.split('\n');

            let headerLineIndex = -1;
            let headers = [];
            let clienteIndex = -1;
            let praticaIndex = -1;
            let commessaIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                // Look for common headers to find the actual data header
                if (line.includes('N¬∞ Offerta') && line.includes('Cliente') && line.includes('RIF.PRATICA')) {
                    headerLineIndex = i;
                    // Split headers by semicolon, as the embedded CSV now uses semicolons
                    headers = line.split(';').map(h => h.trim()); 
                    clienteIndex = headers.indexOf('Cliente');
                    praticaIndex = headers.indexOf('RIF.PRATICA');
                    commessaIndex = headers.indexOf('N¬∞ di Commessa');
                    console.log("Header line found at index:", headerLineIndex, "Headers:", headers);
                    console.log("Indices for Cliente, Pratica, Commessa:", {clienteIndex, praticaIndex, commessaIndex});
                    break;
                }
            }

            if (headerLineIndex === -1 || clienteIndex === -1 || praticaIndex === -1 || commessaIndex === -1) {
                console.error("CRITICAL ERROR: CSV headers (Cliente, RIF.PRATICA, N¬∞ di Commessa) not found or their indices are invalid. Found indices:", {clienteIndex, praticaIndex, commessaIndex});
                return;
            }

            let dataLinesRaw = lines.slice(headerLineIndex + 1);
            console.log("Number of raw data lines (after header):", dataLinesRaw.length);

            parsedCsvData = [];
            praticaDataMap = new Map();
            uniqueClienti = new Set();

            let currentDataRow = null; // Holds the row object currently being built (for multi-line notes)

            dataLinesRaw.forEach((line, lineIndex) => {
                line = line.trim();
                if (line === '') return; // Skip truly empty lines

                const isFooterOrSummary = line.includes('Sede Legale:') || line.includes('DATI COMMESSE');
                if (isFooterOrSummary) {
                    console.log(`Stopping parsing at footer/summary line (original line ${headerLineIndex + 2 + lineIndex}): [${line.substring(0, 50)}...]`);
                    currentDataRow = null; // Reset for good measure
                    return;
                }

                // Split line by semicolon, consistent with header parsing
                const values = line.split(';'); 

                // Attempt to extract RIF.PRATICA from its known position for heuristic
                const praticaCandidate = values[praticaIndex] ? values[praticaIndex].trim() : '';
                const isNewRecord = /\d{5}FLC/.test(praticaCandidate); // Check if it matches the FLC pattern

                // console.log(`Processing data line ${lineIndex + headerLineIndex + 2}: [${line}]`);
                // console.log(`  praticaCandidate: ${praticaCandidate}, isNewRecord: ${isNewRecord}, values.length: ${values.length}`);

                if (isNewRecord) {
                    // This is a new record line
                    let row = {};
                    // Populate row using found indices from the 'values' array
                    // Ensure to handle cases where 'values' array might not have all indices
                    row['N¬∞ Offerta'] = values[headers.indexOf('N¬∞ Offerta')] ? values[headers.indexOf('N¬∞ Offerta')].trim() : '';
                    row['Data Offerta'] = values[headers.indexOf('Data Offerta')] ? values[headers.indexOf('Data Offerta')].trim() : '';
                    row['Cliente'] = values[clienteIndex] ? values[clienteIndex].trim() : '';
                    row['RIF.PRATICA'] = values[praticaIndex] ? values[praticaIndex].trim() : '';
                    row['Esito Ordine'] = values[headers.indexOf('Esito Ordine')] ? values[headers.indexOf('Esito Ordine')].trim() : '';
                    row['N¬∞ di Commessa'] = values[commessaIndex] ? values[commessaIndex].trim() : '';
                    row['n¬∞ Ordine'] = values[headers.indexOf('n¬∞ Ordine')] ? values[headers.indexOf('n¬∞ Ordine')].trim() : '';
                    row['Descrizione lavoro'] = values[headers.indexOf('Descrizione lavoro')] ? values[headers.indexOf('Descrizione lavoro')].trim() : '';
                    row['Luogo di lavoro'] = values[headers.indexOf('Luogo di lavoro')] ? values[headers.indexOf('Luogo di lavoro')].trim() : '';
                    row['Note'] = values[headers.indexOf('Note')] ? values[headers.indexOf('Note')].trim() : '';
                    
                    // Validate essential fields again before adding to data
                    if (row['RIF.PRATICA'] && row['RIF.PRATICA'] !== '' && row['Cliente'] && row['Cliente'] !== '') {
                        parsedCsvData.push(row);
                        praticaDataMap.set(row['RIF.PRATICA'], row);
                        if (row['Cliente']) { // Ensure client exists before adding
                           uniqueClienti.add(row['Cliente']);
                        }
                        currentDataRow = row; 
                        // console.log("  New valid record added:", row['RIF.PRATICA']);
                    } else {
                        console.warn(`  Skipped invalid record (original line ${headerLineIndex + 2 + lineIndex}): Missing RIF.PRATICA or Cliente. Line: [${line}]`);
                        currentDataRow = null; 
                    }
                } else {
                    // This line is a continuation of the previous record's 'Note' field or a stray line
                    if (currentDataRow && currentDataRow['Note'] !== undefined) {
                        currentDataRow['Note'] += ' ' + line; 
                        // console.log(`  Appended to note of ${currentDataRow['RIF.PRATICA'] || 'unknown'}: [${line}]`);
                    } else {
                        // console.log(`  Skipped line (not new record and no active data row to append to): [${line}]`);
                    }
                }
            });

            // Final re-mapping and sorting for dropdowns
            parsedCsvData = parsedCsvData.filter(row => row['RIF.PRATICA'] && row['RIF.PRATICA'] !== '');
            praticaDataMap = new Map(parsedCsvData.map(row => [row['RIF.PRATICA'], row]));
            uniqueClienti = new Set(Array.from(uniqueClienti).sort()); 

            console.log("CSV Parsed (final):", parsedCsvData.length, "entries.");
            console.log("Pratica Map size (final):", praticaDataMap.size);
            console.log("Unique Clienti size (final):", uniqueClienti.size);
            if (praticaDataMap.size === 0) {
                console.error("CRITICAL: Pratica Map is still empty after parsing. Please inspect the console logs for detailed parsing steps and CSV content for inconsistencies.");
            }
        }

        function populateDropdowns() {
            // Populate Codice Pratica dropdown
            const codicePraticaSelect = document.getElementById('codicePraticaSelect');
            if (codicePraticaSelect) {
                codicePraticaSelect.innerHTML = ''; // Clear existing options
                const tbaOption = document.createElement('option');
                tbaOption.value = 'TBA';
                tbaOption.textContent = 'TBA';
                codicePraticaSelect.appendChild(tbaOption);

                Array.from(praticaDataMap.keys()).sort().forEach(pratica => {
                    const option = document.createElement('option');
                    option.value = pratica;
                    option.textContent = pratica;
                    codicePraticaSelect.appendChild(option);
                });
                console.log("Codice Pratica dropdown populated. Number of options (including TBA):", codicePraticaSelect.options.length);
            } else {
                console.error("Element with ID 'codicePraticaSelect' not found.");
            }

            // Populate Azienda dropdown
            const aziendaSelect = document.getElementById('aziendaSelect');
            if (aziendaSelect) {
                aziendaSelect.innerHTML = ''; // Clear existing options
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = ''; // Empty option
                aziendaSelect.appendChild(emptyOption);
                
                uniqueClienti.forEach(cliente => { // uniqueClienti is already sorted now
                    const option = document.createElement('option');
                    option.value = cliente;
                    option.textContent = cliente;
                    aziendaSelect.appendChild(option);
                });
                console.log("Azienda dropdown populated. Number of options (including empty):", aziendaSelect.options.length);
            } else {
                console.error("Element with ID 'aziendaSelect' not found.");
            }
        }

        function handleCodicePraticaChange() {
            const codicePraticaSelect = document.getElementById('codicePraticaSelect');
            const selectedPratica = codicePraticaSelect ? codicePraticaSelect.value : '';

            const numeroCommessaElement = document.getElementById('numeroCommessa');
            const aziendaSelect = document.getElementById('aziendaSelect'); 

            console.log("handleCodicePraticaChange triggered. Selected Pratica:", selectedPratica);

            if (selectedPratica === 'TBA') {
                if (numeroCommessaElement) numeroCommessaElement.textContent = '';
                if (aziendaSelect) aziendaSelect.value = ''; 
                console.log("  TBA selected: Cleared Numero Commessa and Azienda.");
                return;
            }

            const rowData = praticaDataMap.get(selectedPratica);

            if (rowData) {
                if (numeroCommessaElement) {
                    numeroCommessaElement.textContent = rowData['N¬∞ di Commessa'] || '';
                }
                if (aziendaSelect && rowData['Cliente']) {
                    // Check if the option exists, if not add it or ensure the value is set correctly
                    // This ensures that even if 'uniqueClienti' missed an edge case or client name has odd chars, it will be added.
                    if (!Array.from(aziendaSelect.options).some(option => option.value === rowData['Cliente'])) {
                        const newOption = document.createElement('option');
                        newOption.value = rowData['Cliente'];
                        newOption.textContent = rowData['Cliente'];
                        aziendaSelect.appendChild(newOption);
                    }
                    aziendaSelect.value = rowData['Cliente']; 
                }
                console.log("  Fields populated for Pratica:", selectedPratica, "Commessa:", numeroCommessaElement.textContent, "Azienda:", aziendaSelect.value);
            } else {
                console.warn(`  No row data found for selected Pratica: ${selectedPratica}. Clearing fields.`);
                if (numeroCommessaElement) numeroCommessaElement.textContent = '';
                if (aziendaSelect) aziendaSelect.value = '';
            }
        }

        function handleAziendaChange() {
            // This function can be left empty or trigger other logic if needed.
            console.log("Azienda dropdown changed to:", document.getElementById('aziendaSelect')?.value);
        }
        
        // ================================
        // FUNZIONI PDF CORRETTE - SENZA SOVRAPPOSIZIONI
        // ================================
        
        function generatePDF() {
            showNotification('Generazione PDF in corso...', 'info');
            
            try {
                const originalTitle = document.title;
                const offerNumber = document.getElementById('codicePraticaSelect')?.value || 'OFFER'; 
                const currentDate = new Date().toISOString().split('T')[0];
                
                document.title = `FlashControl_${offerNumber}_${currentDate}`;
                
                // Nascondi elementi non necessari per la stampa
                const elementsToHide = document.querySelectorAll('.controls, .delete-btn, .notification, .add-resp-btn');
                elementsToHide.forEach(el => el.style.display = 'none');
                
                // Avvia stampa
                setTimeout(() => {
                    window.print(); 
                    
                    // Ripristina elementi dopo stampa
                    setTimeout(() => {
                        elementsToHide.forEach(el => el.style.display = '');
                        document.title = originalTitle;
                        showNotification('‚úÖ PDF generato con successo!', 'success');
                    }, 1000);
                }, 500);
                
            } catch (error) {
                console.error('Errore generazione PDF:', error);
                showNotification('‚ùå Errore nella generazione PDF', 'error');
            }
        }
        
        function browserPrint() {
            showNotification('Finestra di stampa aperta', 'info');
            window.print();
        }
        
        // ================================
        // GESTIONE SALVATAGGIO/CARICAMENTO
        // ================================

        function handleSave() {
            const choice = confirm('Come desideri salvare l\'offerta?\n\nOK = Esporta come file JSON\nAnnulla = Salva nel browser (Salvataggio rapido)');
            if (choice) {
                exportToJson();
            } else {
                saveOfferToLocalStorage();
            }
        }

        function handleLoad() {
            const choice = confirm('Come desideri recuperare l\'offerta?\n\nOK = Importa da file JSON\nAnnulla = Carica dal browser');
            if (choice) {
                importFromJson();
            } else {
                loadOfferFromLocalStorage();
            }
        }

        function saveOfferToLocalStorage() {
            const offerName = prompt('Nome per salvare l\'offerta nel browser:', generateOfferName());
            if (!offerName || !offerName.trim()) return;
            
            try {
                const offerData = {
                    name: offerName.trim(),
                    savedDate: new Date().toISOString(),
                    data: extractAllData()
                };
                
                let savedOffers = [];
                try {
                    savedOffers = JSON.parse(localStorage.getItem('flashcontrol_offers') || '[]');
                } catch (e) {
                    savedOffers = [];
                }
                
                const existingIndex = savedOffers.findIndex(offer => offer.name === offerName.trim());
                
                if (existingIndex >= 0) {
                    if (!confirm('Esiste gi√† un\'offerta con questo nome. Sovrascrivere?')) {
                        return;
                    }
                    savedOffers[existingIndex] = offerData;
                } else {
                    savedOffers.push(offerData);
                }
                
                localStorage.setItem('flashcontrol_offers', JSON.stringify(savedOffers));
                showNotification(`‚úÖ Offerta "${offerName}" salvata nel browser!`, 'success');
                
            } catch (error) {
                console.error('Errore salvataggio:', error);
                showNotification('‚ùå Errore durante il salvataggio nel browser', 'error');
            }
        }
        
        function loadOfferFromLocalStorage() {
            try {
                const savedOffers = JSON.parse(localStorage.getItem('flashcontrol_offers') || '[]');
                
                if (savedOffers.length === 0) {
                    showNotification('‚ÑπÔ∏è Nessuna offerta salvata nel browser trovata', 'info');
                    return;
                }
                
                const searchCode = prompt('Inserisci il Codice Pratica del preventivo da caricare:');
                if (!searchCode || !searchCode.trim()) {
                    showNotification('‚ÑπÔ∏è Codice Pratica non inserito', 'info');
                    return;
                }

                const foundOffer = savedOffers.find(offer => 
                    offer.data && offer.data.documentInfo && 
                    offer.data.documentInfo.offerNumber.toLowerCase() === searchCode.trim().toLowerCase()
                );

                if (foundOffer) {
                    if (confirm(`Caricare il preventivo per il Codice Pratica "${foundOffer.data.documentInfo.offerNumber}"?\n\nI dati attuali verranno sostituiti.`)) {
                        applyAllData(foundOffer.data);
                        showNotification(`‚úÖ Preventivo con Codice Pratica "${foundOffer.data.documentInfo.offerNumber}" caricato dal browser!`, 'success');
                    }
                } else {
                    showNotification('‚ùå Nessun preventivo trovato con quel Codice Pratica', 'error');
                }
                
            } catch (error) {
                console.error('Errore caricamento:', error);
                showNotification('‚ùå Errore durante il caricamento dal browser', 'error');
            }
        }

        function exportToJson() {
            showNotification('üìÑ Esportazione offerta come file JSON...', 'info');
            try {
                const offerData = extractAllData();
                const jsonString = JSON.stringify(offerData, null, 2);
                
                // Modified to get value from select
                const offerNumber = document.getElementById('codicePraticaSelect')?.value || 'OFFER'; 
                const currentDate = new Date().toISOString().split('T')[0];
                const fileName = `FlashControl_Offerta_${offerNumber}_${currentDate}.json`;

                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('‚úÖ Offerta esportata come JSON!', 'success');
            } catch (error) {
                console.error('Errore durante l\'esportazione JSON:', error);
                showNotification('‚ùå Errore nell\'esportazione JSON', 'error');
            }
        }

        function importFromJson() {
            showNotification('üìÇ Selezione file JSON per importazione...', 'info');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const importedData = JSON.parse(event.target.result);
                            if (confirm('Importare i dati dal file JSON?\n\nI dati attuali verranno sostituiti.')) {
                                applyAllData(importedData);
                                showNotification('‚úÖ Offerta importata con successo dal file JSON!', 'success');
                            }
                        } catch (parseError) {
                            console.error('Errore parsing JSON:', parseError);
                            showNotification('‚ùå Errore: file JSON non valido', 'error');
                        }
                    };
                    reader.readAsText(file);
                } else {
                    showNotification('‚ÑπÔ∏è Nessun file selezionato', 'info');
                }
            };
            input.click();
        }

        // ================================
        // GESTIONE TABELLA
        // ================================
        
        function renumberTableRows() { 
            let currentPos = 0;
            const rows = document.querySelectorAll('#quotationTableBody tr');
            rows.forEach(row => {
                // Controlla se la riga √® un'intestazione di sezione o una riga di totale
                if (row.querySelector('.section-header-cell') || row.querySelector('td[colspan="4"]')) {
                    // Se √® un'intestazione o un totale, non numerarla e resetta il contatore se √® una sezione
                    if (row.querySelector('.section-header-cell')) {
                        currentPos = 0; 
                    }
                    return; 
                }
                
                const posCell = row.querySelector('td:first-child');
                if (posCell) {
                    currentPos++;
                    posCell.textContent = currentPos;
                }
            });
            rowCounter = currentPos; 
        }

        function addTableRow() {
            try {
                const tbody = document.getElementById('quotationTableBody');
                
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td></td> <td>
                        <div class="editable" contenteditable="true"><strong>Nuova voce:</strong> Descrizione del servizio</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">1</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">0,00</div>
                        <button class="delete-btn" onclick="deleteRow(this)">‚úï</button>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true">0,00</div>
                    </td>
                `;
                
                tbody.appendChild(newRow);
                renumberTableRows(); 
                showNotification('‚úÖ Nuova riga aggiunta alla tabella', 'success');
                
            } catch (error) {
                console.error('Errore aggiunta riga:', error);
                showNotification('‚ùå Errore aggiunta riga', 'error');
            }
        }
        
        function deleteRow(button) {
            if (confirm('üóëÔ∏è Eliminare questa riga?')) {
                button.closest('tr').remove();
                renumberTableRows(); 
                showNotification('üóëÔ∏è Riga eliminata', 'info');
            }
        }
        
        function calculateTotal() {
            try {
                let total = 0;
                let itemCount = 0;
                
                const rows = document.querySelectorAll('#quotationTableBody tr');
                rows.forEach(row => {
                    if (row.querySelector('.section-header-cell')) return;
                    
                    const totalCell = row.querySelector('td:last-child .editable');
                    if (totalCell) {
                        const value = totalCell.textContent.trim();
                        const numValue = parseFloat(value.replace(/[^\d.,]/g, '').replace(',', '.'));
                        
                        if (!isNaN(numValue) && numValue > 0) {
                            total += numValue;
                            itemCount++;
                        }
                    }
                });
                
                if (itemCount > 0) {
                    const formattedTotal = total.toLocaleString('it-IT', {minimumFractionDigits: 2});
                    showNotification(`üí∞ Totale: ‚Ç¨ ${formattedTotal} (${itemCount} voci)`, 'success');
                    
                    if (confirm(`Aggiungere riga totale: ‚Ç¨ ${formattedTotal}?`)) {
                        const tbody = document.getElementById('quotationTableBody');
                        const totalRow = document.createElement('tr');
                        totalRow.style.backgroundColor = '#e8f5e8';
                        totalRow.style.fontWeight = 'bold';
                        totalRow.innerHTML = `
                            <td colspan="4" style="text-align: right; background: #4caf50; color: white; padding: 15px;">
                                TOTALE COMPLESSIVO:
                            </td>
                            <td style="text-align: right; background: #e8f5e8; padding: 15px;">
                                ‚Ç¨ ${formattedTotal}
                            </td>
                        `;
                        tbody.appendChild(totalRow);
                    }
                } else {
                    showNotification('‚ÑπÔ∏è Nessun valore numerico trovato', 'info');
                }
                
            } catch (error) {
                console.error('Errore calcolo totale:', error);
                showNotification('‚ùå Errore nel calcolo', 'error');
            }
        }
        
        // ================================
        // GESTIONE NOTE
        // ================================
        
        function addNote() {
            const category = prompt('üìù Categoria della nota:', 'üìå Nota Importante');
            if (!category || !category.trim()) return;
            
            const content = prompt('Contenuto della nota:', 'Inserire qui il contenuto...');
            if (!content || !content.trim()) return;
            
            try {
                const notesContainer = document.getElementById('notesContainer');
                const newNote = document.createElement('div');
                newNote.className = 'note-item';
                newNote.innerHTML = `
                    <strong>${escapeHtml(category)}:</strong>
                    <div class="editable" contenteditable="true">${escapeHtml(content)}</div>
                    <button class="delete-btn" onclick="deleteNote(this)">‚úï</button>
                `;
                notesContainer.appendChild(newNote);
                showNotification('‚úÖ Nota aggiunta con successo!', 'success');
                
            } catch (error) {
                console.error('Errore aggiunta nota:', error);
                showNotification('‚ùå Errore aggiunta nota', 'error');
            }
        }
        
        function deleteNote(button) {
            if (confirm('üóëÔ∏è Eliminare questa nota?')) {
                button.closest('.note-item').remove();
                showNotification('üóëÔ∏è Nota eliminata', 'info');
            }
        }
        
        // ================================
        // GESTIONE RESPONSABILIT√Ä
        // ================================
        
        function addFlashResponsibility() {
            const title = prompt('üî• Titolo responsabilit√† Flash Control:', 'üìã Nuova Responsabilit√†');
            if (!title || !title.trim()) return;
            
            const content = prompt('Descrizione:', 'Inserire descrizione...');
            if (!content || !content.trim()) return;
            
            try {
                const container = document.getElementById('flashResponsibilities');
                const newResp = document.createElement('div');
                newResp.className = 'resp-item flash-item';
                newResp.innerHTML = `
                    <strong>${escapeHtml(title)}:</strong>
                    <div class="editable" contenteditable="true">${escapeHtml(content)}</div>
                    <button class="delete-btn" onclick="deleteResponsibilityItem(this)">‚úï</button>
                `;
                container.appendChild(newResp);
                showNotification('‚úÖ Responsabilit√† Flash Control aggiunta!', 'success');
                
            } catch (error) {
                console.error('Errore aggiunta responsabilit√†:', error);
                showNotification('‚ùå Errore aggiunta responsabilit√†', 'error');
            }
        }
        
        function addClientResponsibility() {
            const title = prompt('üè¢ Titolo responsabilit√† Cliente:', 'üìã Nuova Responsabilit√†');
            if (!title || !title.trim()) return;
            
            const content = prompt('Descrizione:', 'Inserire descrizione...');
            if (!content || !content.trim()) return;
            
            try {
                const container = document.getElementById('clientResponsibilities');
                const newResp = document.createElement('div');
                newResp.className = 'resp-item client-item';
                newResp.innerHTML = `
                    <strong>${escapeHtml(title)}:</strong>
                    <div class="editable" contenteditable="true">${escapeHtml(content)}</div>
                    <button class="delete-btn" onclick="deleteResponsibilityItem(this)">‚úï</button>
                `;
                container.appendChild(newResp);
                showNotification('‚úÖ Responsabilit√† Cliente aggiunta!', 'success');
                
            } catch (error) {
                console.error('Errore aggiunta responsabilit√†:', error);
                showNotification('‚ùå Errore aggiunta responsabilit√†', 'error');
            }
        }
        
        function deleteResponsibilityItem(button) {
            if (confirm('üóëÔ∏è Eliminare questa responsabilit√†?')) {
                button.closest('.resp-item').remove();
                showNotification('üóëÔ∏è Responsabilit√† eliminata', 'info');
            }
        }
        
        // ================================
        // FUNZIONI DI ESPORTAZIONE HTML SEMPLICE (NUOVE)
        // ================================
        
        function exportSimpleHTML() {
            showNotification('‚ö° Generazione HTML semplice per Pandoc...', 'info');
            try {
                const htmlContent = generateOptimizedWordHTML(); // Riutilizza la funzione che genera HTML pulito
                
                // Modified to get value from select
                const offerNumber = document.getElementById('codicePraticaSelect')?.value || 'OFFER'; 
                const currentDate = new Date().toISOString().split('T')[0];
                const fileName = `FlashControl_Offerta_${offerNumber}_${currentDate}.html`;

                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('‚úÖ File HTML generato e pronto per Pandoc!', 'success');
            } catch (error) {
                console.error('‚ùå Errore esportazione HTML:', error);
                showNotification(`‚ùå Errore durante l'esportazione HTML: ${error.message || error}`, 'error');
            }
        }

        // ================================
        // ALTRE FUNZIONI ESISTENTI (nessuna modifica)
        // ================================
        
        function editTagline() {
            const current = document.querySelector('.tagline').innerHTML;
            const newTagline = prompt('‚úèÔ∏è Modifica tagline:\n(Usa <br> per andare a capo)', current);
            
            if (newTagline !== null && newTagline.trim()) {
                document.querySelector('.tagline').innerHTML = newTagline.trim();
                localStorage.setItem('flashcontrol_tagline', newTagline.trim());
                showNotification('‚úÖ Tagline aggiornata!', 'success');
            }
        }
        
        function changeLogo() {
            const choice = confirm('Tipo di logo:\n\nOK = Carica immagine\nAnnulla = Logo testuale');
            
            if (choice) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const logoImage = document.getElementById('logoImage');
                            const logoText = document.getElementById('logoText');
                            
                            logoImage.src = event.target.result;
                            logoImage.style.display = 'block';
                            logoText.style.display = 'none';
                            
                            localStorage.setItem('flashcontrol_logo', event.target.result);
                            showNotification('‚úÖ Logo caricato!', 'success');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            } else {
                const newText = prompt('Testo del logo:', 'FLASH\nCONTROL Srl');
                if (newText !== null) {
                    const logoImage = document.getElementById('logoImage');
                    const logoText = document.getElementById('logoText');
                    
                    logoText.innerHTML = newText.replace(/\n/g, '<br>');
                    logoImage.style.display = 'none';
                    logoText.style.display = 'block';
                    
                    localStorage.removeItem('flashcontrol_logo');
                    showNotification('‚úÖ Logo testuale aggiornato!', 'success');
                }
            }
        }
        
        // ================================
        // FUNZIONI DI UTILIT√Ä ESISTENTI (nessuna modifica)
        // ================================
        
        function getEditableValue(selector, index) {
            const elements = document.querySelectorAll(selector);
            if (elements[index]) { 
                if (elements[index].tagName === 'SELECT') {
                    return elements[index].value.trim();
                } else {
                    return elements[index].textContent.trim();
                }
            }
            return '';
        }
        
        function generateOfferName() {
            // Modified to get value from select
            const client = document.getElementById('aziendaSelect')?.value || 'CLIENT';
            const offer = document.getElementById('codicePraticaSelect')?.value || 'OFFER'; 
            const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
            return `${offer}_${client.substring(0, 10)}_${date}`.replace(/[^a-zA-Z0-9_]/g, '_');
        }
        
        function extractAllData() {
            const logoImage = document.getElementById('logoImage');
            const logoText = document.getElementById('logoText');
            
            return {
                documentInfo: {
                    offerNumber: document.getElementById('codicePraticaSelect')?.value || '', 
                    date: getEditableValue('.document-info .editable', 0), // Index shifted
                    numeroCommessa: document.getElementById('numeroCommessa')?.textContent.trim() || '', 
                    validUntil: getEditableValue('.document-info .editable', 1) // Index shifted
                },
                logoImage: logoImage.style.display === 'block' ? logoImage.src : null,
                logoText: logoText.style.display === 'block' ? logoText.textContent.trim() : null,
                tagline: document.querySelector('.tagline').innerHTML,
                client: {
                    company: document.getElementById('aziendaSelect')?.value || '', 
                    contact: getEditableValue('.client-section .editable', 1),
                    email: getEditableValue('.client-section .editable', 2),
                    phone: getEditableValue('.client-section .editable', 3)
                },
                reference: {
                    yourRef: getEditableValue('.reference-section .editable', 0),
                    object: getEditableValue('.reference-section .editable', 1),
                    description: getEditableValue('.reference-section .editable', 2), 
                    location: getEditableValue('.reference-section .editable', 3), 
                    timeline: getEditableValue('.reference-section .editable', 4)  
                },
                conditions: {
                    validity: getEditableValue('.conditions-section .editable', 0),
                    payment: getEditableValue('.conditions-section .editable', 1),
                    delivery: getEditableValue('.conditions-section .editable', 2),
                    currency: getEditableValue('.conditions-section .editable', 3)
                },
                items: extractTableItems(),
                notes: extractNotes(),
                responsibilities: {
                    flash: extractResponsibilities('#flashResponsibilities'),
                    client: extractResponsibilities('#clientResponsibilities')
                },
                footer: {
                    address: getEditableValue('.footer .editable', 0),
                    phoneAndFax: getEditableValue('.footer .editable', 1),
                    emailAndWeb: getEditableValue('.footer .editable', 2),
                    vatAndCf: getEditableValue('.footer .editable', 3)
                }
            };
        }
        
        function extractTableItems() {
            const items = [];
            const rows = document.querySelectorAll('#quotationTableBody tr');
            let currentPos = 0;

            rows.forEach(row => {
                const sectionHeaderCell = row.querySelector('.section-header-cell');
                const totalRowCell = row.querySelector('td[colspan="4"]');

                if (sectionHeaderCell) {
                    items.push({
                        isSectionHeader: true,
                        description: sectionHeaderCell.querySelector('.editable')?.textContent.trim() || ''
                    });
                    currentPos = 0;
                } else if (totalRowCell) {
                     items.push({
                        isTotalRow: true,
                        total: totalRowCell.nextElementSibling.textContent.trim()
                    });
                }
                else {
                    const cells = row.children;
                    if (cells.length >= 5) {
                        currentPos++;
                        const description = cells[1].querySelector('.editable')?.textContent.trim() || '';
                        const quantity = cells[2].querySelector('.editable')?.textContent.trim() || '';
                        const unitPrice = cells[3].querySelector('.editable')?.textContent.trim() || '';
                        const total = cells[4].querySelector('.editable')?.textContent.trim() || '';
                        
                        if (description) {
                            items.push({ position: currentPos, description, quantity, unitPrice, total });
                        }
                    }
                }
            });
            
            return items;
        }
        
        function extractNotes() {
            const notes = [];
            const noteElements = document.querySelectorAll('.note-item');
            
            noteElements.forEach(noteEl => {
                const strongEl = noteEl.querySelector('strong');
                const editableEl = noteEl.querySelector('.editable');
                
                if (strongEl && editableEl) {
                    notes.push({
                        category: strongEl.textContent.trim(),
                        content: editableEl.textContent.trim()
                    });
                }
            });
            
            return notes;
        }
        
        function extractResponsibilities(containerId) {
            const responsibilities = [];
            const container = document.querySelector(containerId);
            const items = container ? container.querySelectorAll('.resp-item') : [];
            
            items.forEach(item => {
                const strongEl = item.querySelector('strong');
                const editableEl = item.querySelector('.editable');
                
                if (strongEl && editableEl) {
                    responsibilities.push({
                        title: strongEl.textContent.trim().replace(':', ''),
                        content: editableEl.textContent.trim()
                    });
                }
            });
            
            return responsibilities;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ================================
        // INIZIALIZZAZIONE
        // ================================
        
        function initializeSystem() {
            console.log('üöÄ Flash Control v2.1 con CloudConvert - Sistema Inizializzato');
            
            parseCsvData(csvContent); // Parse CSV data on load
            populateDropdowns(); // Populate dropdowns after parsing

            // Initial trigger for Codice Pratica change to populate fields on load
            // Only if there are actual options available and not just TBA
            const codicePraticaSelect = document.getElementById('codicePraticaSelect');
            if (codicePraticaSelect && praticaDataMap.size > 0) {
                // Set initial value to the first sorted real pratica, or 'TBA'
                const firstPratica = Array.from(praticaDataMap.keys()).sort()[0];
                codicePraticaSelect.value = firstPratica; 
                handleCodicePraticaChange(); // Trigger change to populate associated fields
            } else if (codicePraticaSelect) {
                codicePraticaSelect.value = 'TBA'; // Ensure TBA is selected if no other data
                handleCodicePraticaChange(); // Trigger change to clear associated fields
            }


            const savedTagline = localStorage.getItem('flashcontrol_tagline');
            if (savedTagline) {
                document.querySelector('.tagline').innerHTML = savedTagline;
            }
            
            const savedLogo = localStorage.getItem('flashcontrol_logo');
            if (savedLogo) {
                const logoImage = document.getElementById('logoImage');
                const logoText = document.getElementById('logoText');
                
                logoImage.src = savedLogo;
                logoImage.style.display = 'block';
                logoText.style.display = 'none';
            }
            
            renumberTableRows(); 
            showNotification('‚ö° Sistema Flash Control con CloudConvert pronto!', 'success');
        }
        
        // Avvia al caricamento
        document.addEventListener('DOMContentLoaded', initializeSystem);
        
        // Scorciatoie tastiera
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                handleSave();
            }
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                handleLoad();
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                generatePDF();
            }
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                exportToWordCloudConvert();
            }
        });
        
        console.log('‚úÖ Flash Control v2.1 con CloudConvert - Caricato e Funzionante!');
    </script>
</body>
</html>
